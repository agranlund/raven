;-------------------------------------------------------------------------------
; Raven xbios extensions
; (c) 2024 Anders Granlund
;
; Parts of this code is derived from CT60 xbios (c) Didier Mequignon
;-------------------------------------------------------------------------------
;
; This file is free software  you can redistribute it and/or modify
; it under the terms of the GNU General Public License as published by
; the Free Software Foundation  either version 2, or (at your option)
; any later version.
;
; This file is distributed in the hope that it will be useful,
; but WITHOUT ANY WARRANTY  without even the implied warranty of
; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
; GNU General Public License for more details.
;
; You should have received a copy of the GNU General Public License
; along with this program  if not, write to the Free Software
; Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
;
;-------------------------------------------------------------------------------



;-------------------------------------------------------------------------------
;	TOS1
;		0x0016	void SetTime(u32 time)
;		0x0017	u32  GetTime(void)
;
;	TOS3
;		0x002E	i16  NVMAccess(i16 op, i16 start, i16 count, i8* buf)
;
;	CT60/Milan
;		0x00A0 	i32  CacheCtrl(i16 op, i16 param)
;
;	CT60
;		0xC60C	i32  ct60_cache(i16 mode)
;		0xC60D	i32  ct60_flush_cache(i16 mode)
;		0xC60A	i32  ct60_read_temp(i16 type)
;		0xC60B	i32  ct60_rwparam(i16 mode, i32 type, i16 val)
;		0xC60E	i32  ct60_vmalloc(i16 mode, i32 value)
;-------------------------------------------------------------------------------
	.XREF 	xbc_settime
	.XREF 	xbc_gettime
	.XREF 	xbc_nvmaccess

	.EXPORT InstallXbios
	.EXPORT LogoPic

	.TEXT

	
;----------------------------------------------------------
cache_enable:
	movec.l	cacr,d0
	btst.b	#31,d0
	bne.b	.1
	move.l	#0xA0C08000,d0		; EDC, ESB, EBC, EIC
	nop
	cinva	bc
	nop
	movec.l	d0,cacr
.1:	rts

cache_disable:
	movec.l	cacr,d0
	btst.b	#31,d0
	beq.b	.1
	moveq.l	#0,d0
	nop
	cpusha	bc
	nop
	movec.l	d0,cacr
.1:	rts



;----------------------------------------------------------
xb_cache_ctrl:
	or.w	#0x0700,sr		; disable interrupts
	move.w	2(a0),d0		; d0 = opcode
	move.w	4(a0),d1		; d1 = param
.0:	cmp.w	#0,d0			; query implemented
	bne.b	.1
	moveq.l	#0,d0
	rte
.1:	cmp.w	#1,d0			; flush data cache
	bne.b	.2
	nop
	cpusha	dc
	nop
	moveq.l	#0,d0
	rte
.2:	cmp.w	#2,d0			; flush instruction cache
	bne.b	.3
	nop
	cpusha	ic
	nop
	moveq.l	#0,d0
	rte
.3:	cmp.w	#3,d0			; flush both caches
	bne.b	.4
	nop
	cpusha	bc
	nop
	moveq.l	#0,d0
	rte
.4:	cmp.w	#4,d0			; inquire data cache mode
	bne.b	.5
	movec.l	cacr,d0
	rol.l	#1,d0
	and.l	#1,d0
	rte
.5:	cmp.w	#5,d0			; activate/deactivate data cace
	bne.b	.6
	cmp.w	#0,d1
	bne.b	.5a
	bsr		cache_disable		; disable all caches like CT60
	bra.b	.5b
.5a:bsr		cache_enable		; enable all caches like CT60
.5b:moveq.l	#0,d0
	rte
.6:	cmp.w	#6,d0			; inquire instruction cache mode
	bne.b	.7
	movec.l	cacr,d0
	rol.w	#1,d0
	and.l	#1,d0
	rte
.7:	cmp.w	#7,d0			; activate/deactivate instruction cache
	bne.b	.8
	cmp.w	#0,d1
	bne.b	.7a
	bsr		cache_disable		; disable all caches like CT60
	bra.b	.7b
.7a:bsr		cache_enable		; enable all caches like CT60
.7b:moveq.l	#0,d0
	rte
.8:	move.l	#-5,d0			; EBADRQ
	rte


;----------------------------------------------------------
xb_ct60_cache:
	or.w	#0x0700,sr		; disable interrupts
	move.w	2(a0),d0
	bmi.b	.2
	bne.b	.1
.0:	bsr		cache_disable
	bra.b	.2
.1:	bsr		cache_enable
.2:	movec.l	cacr,d0
	rte


;----------------------------------------------------------
xb_ct60_flush_cache:
	or.w	#0x0700,sr		; disable interrupts
;	movec.l	cacr,d0
;	btst.b	#31,d0
;	bne.b	.1
	nop
	cpusha	bc
	nop
.1:	rte


;----------------------------------------------------------
xb_ct60_read_temp:
	or.w	#0x0700,sr		; disable interrupts
	moveq.l	#0,d0
	rte


;----------------------------------------------------------
xb_ct60_rwparam:
	or.w	#0x0700,sr		; disable interrupts
	moveq.l	#0,d0
	rte


;----------------------------------------------------------
xb_ct60_vmalloc:
	or.w	#0x0700,sr		; disable interrupts
	moveq.l	#0,d0
	rte

	
;----------------------------------------------------------
xb_settime:
	or.w	#0x0700,sr		; disable interrupts
	; call tos settime
	move.l	2(a0),-(sp)		; time
	move.w	(a0),-(sp)		; opcode
	move.w	#0,-(sp)		; fake
	move.l	#.1,-(sp)		; return
	move.w	sr,-(sp)		; sr
	movea.l	xbios_old(pc),a0
	jmp		(a0)
	; call our settime
.1:	addq.l	#2,sp			; ignore opcode
	move.l	(sp)+,d0		; time parameter
	bsr		xbc_settime
	rte
	
;----------------------------------------------------------
xb_gettime:
	or.w	#0x0700,sr		; disable interrupts
	bsr		xbc_gettime
	rte
	
;----------------------------------------------------------
xb_nvmaccess:
	or.w	#0x0700,sr		; disable interrupts
	move.w	2(a0),d0		; op
	move.w	4(a0),d1		; start
	move.w	6(a0),d2		; count
	move.l	8(a0),a0		; buffer
	bsr		xbc_nvmaccess
	rte
	

;----------------------------------------------------------
;
; Trap14 xbios handler
;
;----------------------------------------------------------
	DC.B "XBRA"
	DC.B "RAVN"
xbios_old:
	DC.L 0x00B8
xbios_new:
	move	usp,a0
	btst	#5,(sp)			; already super?
	beq.b	.1
	lea		8(sp),a0		; assume longframe
.1:	sub.l	d0,d0
	move.w	(a0),d0			; d0 = opcode

	cmp.w	#0xC600,d0		; 
	bcc		xbios_ct60
	
	;------------------------------------
	; Atari Xbios
	; todo: jumptable these
	;------------------------------------
IFNE XBTIME
	cmp.w	#22,d0			; Settime
	beq		xb_settime
	cmp.w	#23,d0			; Gettime
	beq		xb_gettime
ENDIF

IFNE XBNVM
	cmp.w	#46,d0			; NVMaccess
	beq		xb_nvmaccess
ENDIF

	;------------------------------------
	; Milan / CT60
	;------------------------------------
	cmp.w	#120,d0			; CacheCtrl
	beq 	xb_cache_ctrl
	movea.l	xbios_old(pc),a0
	jmp		(a0)
	

xbios_ct60:
	;------------------------------------
	; CT60
	; todo: jumptable 0xC60? + 0x0C6?
	;------------------------------------
	cmp.w	#0xC60C,d0
	beq 	xb_ct60_cache
	cmp.w	#0xC60D,d0
	beq 	xb_ct60_flush_cache
#if 0
	cmp.w	#0xC60A,d0
	beq 	xb_ct60_read_temp
	cmp.w	#0xC60B,d0
	beq 	xb_ct60_rwparam
	cmp.w	#0xC60E,d0
	beq 	xb_ct60_vmalloc
#endif
	movea.l	xbios_old(pc),a0
	jmp		(a0)
ENDMOD


;----------------------------------------------------------
InstallXbios:
	movem.l	d0/a0,-(sp)			; save registers
	move.w	sr,-(sp)			; disable interrupts
	move.w	#0x2700,sr
	move.l	0x0b8.w,xbios_old	; xbios trap handler
	move.l	#xbios_new,0x0b8.w
	move.w	(sp)+,sr			; restore interrupts
	movem.l	(sp)+,d0/a0			; restore registers
	rts


LogoPic:
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%01111001111111110011110000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%11111001111111110011111000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%11111001111111110011111000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%11111001111111110011111000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%11111001111111110011111000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%11111001111111110011111000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%11111001111111110011111000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000001,%11111001111111110011111100000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000001,%11111001111111110011111100000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000001,%11111001111111110011111100000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000001,%11111001111111110011111100000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000011,%11111001111111110011111110000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000011,%11111001111111110011111110000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000011,%11111001111111110011111110000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000111,%11110001111111110001111111000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000111,%11110001111111110001111111000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000001111,%11110001111111110001111111100000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000001111,%11110001111111110001111111100000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000011111,%11100001111111110000111111110000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000111111,%11100001111111110000111111111000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000111111,%11100001111111110000111111111000,%00000000000000000000000000000000
    dc.l %00000000000000000000000001111111,%11000001111111110000011111111100,%00000000000000000000000000000000
    dc.l %00000000000000000000000011111111,%11000001111111110000011111111110,%00000000000000000000000000000000
    dc.l %00000000000000000000000111111111,%10000001111111110000001111111111,%00000000000000000000000000000000
    dc.l %00000000000000000000001111111111,%10000001111111110000001111111111,%10000000000000000000000000000000
    dc.l %00000000000000000000011111111111,%00000001111111110000000111111111,%11000000000000000000000000000000
    dc.l %00000000000000000000111111111110,%00000001111111110000000011111111,%11100000000000000000000000000000
    dc.l %00000000000000000001111111111110,%00000001111111110000000011111111,%11110000000000000000000000000000
    dc.l %00000000000000000111111111111100,%00000001111111110000000001111111,%11111100000000000000000000000000
    dc.l %00000000000000001111111111111000,%00000001111111110000000000111111,%11111110000000000000000000000000
    dc.l %00000000000000111111111111110000,%00000001111111110000000000011111,%11111111100000000000000000000000
    dc.l %00000000000111111111111111100000,%00000001111111110000000000001111,%11111111111100000000000000000000
    dc.l %00000000111111111111111111000000,%00000001111111110000000000000111,%11111111111111100000000000000000
    dc.l %00000000111111111111111110000000,%00000001111111110000000000000011,%11111111111111100000000000000000
    dc.l %00000000111111111111111100000000,%00000001111111110000000000000001,%11111111111111100000000000000000
    dc.l %00000000111111111111110000000000,%00000001111111110000000000000000,%01111111111111100000000000000000
    dc.l %00000000111111111111100000000000,%00000001111111110000000000000000,%00111111111111100000000000000000
    dc.l %00000000111111111110000000000000,%00000001111111110000000000000000,%00001111111111100000000000000000
    dc.l %00000000111111111000000000000000,%00000001111111110000000000000000,%00000011111111100000000000000000
    dc.l %00000000111111000000000000000000,%00000001111111110000000000000000,%00000000111111100000000000000000
    dc.l %00000000111000000000000000000000,%00000001111111110000000000000000,%00000000000011100000000000000000
    dc.l %00000000000000000000000000000000,%00000000000000000000000000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%00000000000000000000000000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%00000000000000000000000000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%00000000000000000000000000000000,%00000000000000000000000000000000
    dc.l %00000000000000000000000000000000,%00000000000000000000000000000000,%00000000000000000000000000000000
    dc.l %00000000000000001100000001111111,%11111110000000110000000000000111,%11000000000111100000011100000000
    dc.l %00000000000000011110000001111111,%11111110000001111000000000011111,%11111000000111100001100011000000
    dc.l %00000000000000111110000001111111,%11111110000011111000000000111111,%11111100000111100001011101000000
    dc.l %00000000000000111111000001111111,%11111110000011111100000000111111,%11111110000111100010010100100000
    dc.l %00000000000000111111000001111111,%11111110000011111100000000111111,%11111110000111100010011000100000
    dc.l %00000000000001111111100000000011,%11000000000111111110000000111100,%00011111000111100010010100100000
    dc.l %00000000000001111111100000000011,%11000000000111111110000000111100,%00001111000111100001010101000000
    dc.l %00000000000001111111100000000011,%11000000000111111110000000111100,%00001111000111100001100011000000
    dc.l %00000000000011110111110000000011,%11000000001111011111000000111100,%00001111000111100000011100000000
    dc.l %00000000000011110011110000000011,%11000000001111001111000000111100,%00001111000111100000000000000000
    dc.l %00000000000011110011110000000011,%11000000001111001111000000111100,%00011110000111100000000000000000
    dc.l %00000000000111100011111000000011,%11000000011110001111100000111100,%11111110000111100000000000000000
    dc.l %00000000000111100001111000000011,%11000000011110000111100000111101,%11111100000111100000000000000000
    dc.l %00000000000111100001111000000011,%11000000011110000111100000111101,%11111000000111100000000000000000
    dc.l %00000000001111100001111100000011,%11000000111110000111110000111101,%11100000000111100000000000000000
    dc.l %00000000001111111111111100000011,%11000000111111111111110000111101,%11100000000111100000000000000000
    dc.l %00000000001111111111111100000011,%11000000111111111111110000111101,%11100000000111100000000000000000
    dc.l %00000000011111111111111110000011,%11000001111111111111111000111100,%11110000000111100000000000000000
    dc.l %00000000011111111111111110000011,%11000001111111111111111000111100,%11111000000111100000000000000000
    dc.l %00000000011110000000011110000011,%11000001111000000001111000111100,%01111000000111100000000000000000
    dc.l %00000000111110000000011111000011,%11000011111000000001111100111100,%00111100000111100000000000000000
    dc.l %00000000111100000000011111000011,%11000011110000000001111100111100,%00111110000111100000000000000000
    dc.l %00000000111100000000001111000011,%11000011110000000000111100111100,%00011110000111100000000000000000
    dc.l %00000001111100000000001111100011,%11000111110000000000111110111100,%00011111000111100000000000000000
    dc.l %00000001111000000000000111100011,%11000111100000000000011110111000,%00001111000111100000000000000000
